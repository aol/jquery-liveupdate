/*! Live Update - v0.2.1 - 2013-08-28, 1:57PM EDT
* https://github.com/aol/jquery-liveupdate
* Copyright (c) 2013 Nate Eagle and Jeremy Jannotta; Licensed BSD */
(function(t){t.fn.liveUpdateApi=function(e){var i=this,n=arguments,a={begin:null,end:null,alive:!0,callbackPrefix:"LB_U",url:null,postId:null,trafficPing:!0,fetch:null,pollInterval:null,sonar:!0},s=i.data("lbl-state")||{},o=function(){i.data("lbl-state",s)},l=function(t,e){e=e||[];var i,n,a,s,o,l={},r=t,u={1:"text",2:"image",4:"comment"};for(i=0,n=e.length;n>i;i+=1)o=e[i],l[o.m]={name:o.name,slug:o.slug};for(s in r)if(r.hasOwnProperty(s))for(i=0,n=r[s].length;r[s].length>i;i+=1)a=r[s][i],a.m&&(a.memberId=a.m,a.memberName=l[a.memberId].name,a.memberSlug=l[a.memberId].slug,delete a.m),a.t&&(a.date=new Date(1e3*a.t),delete a.t),a.type&&(a.type=u[a.type]||"unknown"),a.d&&(a.content=a.d,delete a.d),a.md&&a.md.caption&&(a.caption=a.md.caption||"",delete a.md.caption),a.md&&a.md.tags&&(a.tags=a.md.tags||[],delete a.md.tags);return r},r=function(t){var e=3e3,n=new Date,a=null;a="error"===(t.status+"").toLowerCase()?"disabled":0===t.int&&0===t.last_update?"notstarted":0===t.int&&t.last_update>0?"completed":"live",s.postStatus!==a&&(s.postStatus=a,i.trigger({type:"status",status:a})),s.options.pollInterval?e=1e3*s.options.pollInterval:t.int>0&&(e=1e3*t.int),t.last_update===s.lastUpdate?s.count+=1:t.last_update>s.lastUpdate&&(s.lastUpdate=t.last_update,s.count=0),s.options.alive&&(!s.options.end||s.options.end>n?s.timer=setTimeout(d.fetch,e):s.options.end&&n>=s.options.end&&(s.options.alive=!1,i.trigger("end"))),t.data&&(s.first===!0&&(delete s.first,i.trigger("begin")),i.trigger("update",l(t.data,t.members))),o()},u=function(){s.options.alive&&(s.timer=setTimeout(d.fetch,1e4)),o()},d={init:function(e){var n;i.data("lbl-state")===void 0&&(s.lastUpdate=s.lastUpdate||0,s.count=s.count||0,s.options=t.extend(!0,{},a,e),s.options.url&&"/"!==s.options.url.substring(s.options.url.length-1)&&(s.options.url+="/"),s.options.sonar&&(i.bind("scrollin",function(){d.live()}),i.bind("scrollout",function(){d.die()})),o(),n=function(){var t=new Date;s.options.begin?t>s.options.begin?(s.first=!0,d.trafficPing(),d.fetch()):s.timer=setTimeout(n,1e4):(s.first=!0,d.fetch())},n())},live:function(){s.options.alive===!1&&d.fetch(),s.options.alive=!0,o()},die:function(){s.options.alive=!1,d.trafficPing(!1),o()},reset:function(){s.count=0,s.lastUpdate=0,clearTimeout(s.timer),d.fetch()},fetch:function(){var e,n=i.data("lbl-state"),a=n.options,s=a.callbackPrefix+n.lastUpdate+"_C"+n.count;a.trafficPing&&!n.trafficPing&&d.trafficPing(),a.fetch?a.fetch(n,r,u):(e=a.url+"live-update/"+a.postId+"/"+n.lastUpdate,t.ajax({cache:!0,dataType:"jsonp",jsonpCallback:s,url:e,success:r,error:u}))},pause:function(){s.paused=!0,clearTimeout(s.timer),d.trafficPing(!1),o()},play:function(){s.paused=!1,d.fetch(),o()},trafficPing:function(t){var e,i=3e4,n=s.options.postId,a=encodeURIComponent(window.location.pathname);t!==!1&&(t=!0),t!==!0||s.trafficPing?t===!1&&(clearInterval(s.trafficPing),delete s.trafficPing):s.trafficPing=setInterval(function(){e=new Image,e.src=s.options.url+"traffic/?t=js&bv=&os="+n+"&tz=&lg=&rv=&rsv=&pw="+a+"&cb="},i)}};return this.each(function(){return d[e]?d[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?(t.error("Method "+e+" does not exist on jQuery.liveBlogApi."),void 0):d.init.apply(this,n)})}})(jQuery);