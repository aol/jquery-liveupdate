(function(e){e.fn.liveUpdateApi=function(t){var n=this,r=arguments,i={begin:null,end:null,alive:!0,callbackPrefix:"LB_U",url:null,postId:null,trafficPing:!0,fetch:null,pollInterval:null,sonar:!0},s=n.data("lbl-state")||{},o=function(){n.data("lbl-state",s)},u=function(e,t){t=t||[];var n,r,i,s,o,u={},a=e,f={1:"text",2:"image",4:"comment"};for(n=0,r=t.length;n<r;n+=1)o=t[n],u[o.m]={name:o.name,slug:o.slug};for(s in a)if(a.hasOwnProperty(s))for(n=0,r=a[s].length;n<a[s].length;n+=1)i=a[s][n],i.m&&(i.memberId=i.m,i.memberName=u[i.memberId].name,i.memberSlug=u[i.memberId].slug,delete i.m),i.t&&(i.date=new Date(i.t*1e3),delete i.t),i.type&&(i.type=f[i.type]||"unknown"),i.d&&(i.content=i.d,delete i.d),i.md&&i.md.caption&&(i.caption=i.md.caption||"",delete i.md.caption),i.md&&i.md.tags&&(i.tags=i.md.tags||[],delete i.md.tags);return a},a=function(e){var t=3e3,r=new Date,i=null;String(e.status).toLowerCase()==="error"?i="disabled":e.int===0&&e.last_update===0?i="notstarted":e.int===0&&e.last_update>0?i="completed":i="live",s.postStatus!==i&&(s.postStatus=i,n.trigger({type:"status",status:i})),s.options.pollInterval?t=s.options.pollInterval*1e3:e.int>0&&(t=e.int*1e3),e.last_update===s.lastUpdate?s.count+=1:e.last_update>s.lastUpdate&&(s.lastUpdate=e.last_update,s.count=0),s.options.alive&&(!s.options.end||s.options.end>r?s.timer=setTimeout(l.fetch,t):s.options.end&&s.options.end<=r&&(s.options.alive=!1,n.trigger("end"))),e.data&&(s.first===!0&&(delete s.first,n.trigger("begin")),n.trigger("update",u(e.data,e.members))),o()},f=function(e){s.options.alive&&(s.timer=setTimeout(l.fetch,1e4)),o()},l={init:function(t){var r;typeof n.data("lbl-state")=="undefined"&&(s.lastUpdate=s.lastUpdate||0,s.count=s.count||0,s.options=e.extend(!0,{},i,t),s.options.url&&s.options.url.substring(s.options.url.length-1)!=="/"&&(s.options.url+="/"),s.options.sonar&&(n.bind("scrollin",function(e){l.live()}),n.bind("scrollout",function(e){l.die()})),o(),r=function(){var e=new Date;s.options.begin?s.options.begin<e?(s.first=!0,l.trafficPing(),l.fetch()):s.timer=setTimeout(r,1e4):(s.first=!0,l.fetch())},r())},live:function(){s.options.alive===!1&&l.fetch(),s.options.alive=!0,o()},die:function(){s.options.alive=!1,l.trafficPing(!1),o()},reset:function(){s.count=0,s.lastUpdate=0,clearTimeout(s.timer),l.fetch()},fetch:function(){var t,r=n.data("lbl-state"),i=r.options,s=i.callbackPrefix+r.lastUpdate+"_C"+r.count;i.trafficPing&&!r.trafficPing&&l.trafficPing(),i.fetch?i.fetch(r,a,f):(t=i.url+"live-update/"+i.postId+"/"+r.lastUpdate,e.ajax({cache:!0,dataType:"jsonp",jsonpCallback:s,url:t,success:a,error:f}))},pause:function(){s.paused=!0,clearTimeout(s.timer),l.trafficPing(!1),o()},play:function(){s.paused=!1,l.fetch(),o()},trafficPing:function(e){var t,n=3e4,r=s.options.postId,i=encodeURIComponent(window.location.pathname);e!==!1&&(e=!0),e===!0&&!s.trafficPing?s.trafficPing=setInterval(function(){t=new Image,t.src=s.options.url+"traffic/?t=js&bv=&os="+r+"&tz=&lg=&rv=&rsv=&pw="+i+"&cb="},n):e===!1&&(clearInterval(s.trafficPing),delete s.trafficPing)}};return this.each(function(){if(l[t])return l[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return l.init.apply(this,r);e.error("Method "+t+" does not exist on jQuery.liveBlogApi.")})}})(jQuery);