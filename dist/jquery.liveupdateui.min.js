/*! Live Update - v0.2 - 2013-07-19, 2:30PM EDT
* https://github.com/aol/jquery-liveupdate
* Copyright (c) 2013 Nate Eagle and Jeremy Jannotta; Licensed BSD */
(function(t){t.fn.liveUpdateUi=function(e){var i={toolbarEnabled:!1,timelineEnabled:!0,pageSize:0,tweetButtons:!0,height:0,linkParams:null,thumbnails:!0,dims:!0,thumbnailDimensions:{height:100,width:null},thumbnailExcludeFilter:null,postLimit:null,memberSettings:null,placeholderImage:"http://o.aolcdn.com/js/x.gif"},n=function(t){var e=document.createElement("DIV");return e.innerHTML=t,e.textContent||e.innerText},a=t(this),s=function(e){if(t.fn.liveUpdateApi){var s=t.extend(!0,{},i,e),o=!1,l=window.location.hash;if(l.length){var r,u,d=l.indexOf("tag=");d>-1&&(u=d+4,r=l.substring(u,l.length),r=decodeURIComponent(r),s.tagFilter=r)}if(!s.linkParams||"?"!==s.linkParams.charAt(0)&&"&"!==s.linkParams.charAt(0)||(s.linkParams=s.linkParams.substr(1)),s.thumbnailExcludeFilter&&(s.thumbnailExcludeFilter=t.trim(s.thumbnailExcludeFilter)),s.placeholderImage){var c=new Image;c.src=s.placeholderImage}if(s.thumbnailDimensions){var h=s.thumbnailDimensions.height?"height:"+s.thumbnailDimensions.height+"px;":"",p=s.thumbnailDimensions.width?"width:"+s.thumbnailDimensions.width+"px;":"";t('<style id="lb-style">.lb .lb-post img { '+p+h+" }</style>").appendTo("head")}a.bind("begin",function(){a.empty();var e,i=!0,l=s.pageSize,r=[],u=0,d=0,c=null,h=null,p=null,m=null,f=null,g=null,b=null,v=0,w=!1,y=!1,x=function(e,i){var n,a,o,l,r,u,d,c,h,p,m=e.content,f=e.type,g=e.id,b=e.caption,v=e.tags,w=e.date,y=e.memberId,x=!i,C=t.extend({profileImage:null,featured:!1},s.memberSettings&&s.memberSettings[y]);if(n='<a href="#p'+g+'">'+M(w)+"</a>",C.featured||(n+=' by <span class="lb-blogger-name">'+e.memberName+"</span>"),s.tagFilter&&(!v||-1===t.inArray(s.tagFilter,v)))return[];if(x?i=t("<p />",{id:"p"+g,"class":"lb-post"}).data("date",e.date.getTime()).toggleClass("lb-featured",C.featured||!1):(i.empty().addClass("lb-edited"),n+=" - edited"),i.data("imagesLoaded",!1),"text"===f||"comment"===f?(i.append(_(m,"lb-post-text")),"comment"===f?(i.addClass("lb-comment"),i.prepend(c=t('<div class="lb-comment-icon"/>').append(t('<div class="lb-comment-icon-dot"/>')))):i.data("comments")||i.data("comments",0)):"image"===f&&(s.thumbnails&&O(m)?(o=m,a=s.dims?t.getDynamicImageSrc(m,s.thumbnailDimensions.width,s.thumbnailDimensions.height):m.replace(/(\.gif|\.jpg|\.jpeg|\.png)$/,"_thumbnail$1")):a=m,i.append(l=t("<img />",{src:s.placeholderImage,"data-src":a||"","data-full-src":o||"",alt:"",title:"Click to view larger","class":"lb-pending"}),_(b,"lb-post-caption")),!s.thumbnailDimensions||s.thumbnails&&a!==m||(l.css("max-width",s.thumbnailDimensions.width||null),l.css("max-height",s.thumbnailDimensions.height||null))),i.append(d=t("<span />",{"class":"lb-post-info"}).append(t("<span />",{html:n,"class":"lb-post-timestamp"}))),(C.profileImage||C.featured)&&(h=t("<span/>",{"class":"lb-post-author-tab"}),C.profileImage&&(p=t("<img/>",{"class":"lb-profile-image lb-pending",src:s.placeholderImage,"data-src":C.profileImage,alt:"",title:e.memberName}).appendTo(h)),C.featured&&h.append('<span class="lb-blogger-name">'+e.memberName+"</span>"),c?h.insertAfter(c):i.prepend(h)),e.tags&&e.tags.length){var T=t("<ul />",{"class":"lb-post-tags"}).appendTo(d);t.each(e.tags,function(e,i){T.append(t("<li />",{html:'<a href="#tag='+encodeURIComponent(i)+'" class="tag" title="Show only updates with this tag">'+i+"</a>","class":0===e?"lb-first":null}))})}return s.tweetButtons&&(u=b||m,r=E(g,u),i.bind("mouseenter",function(){i.unbind("mouseenter"),d.append(r),twttr.widgets.load(i.get(0))})),i},_=function(e,i){i=i||"lb-post-text";var n;return n=t("<span />",{html:e,"class":i}),n.find("a").attr("target","_blank"),s.linkParams&&n.find("a[href]").each(function(e,i){var n=t(i),a=n.attr("href"),o=a.indexOf("#"),l=(-1===a.indexOf("?")?"?":"&")+s.linkParams;-1!==o?a=a.substring(0,o)+l+a.substring(o):a+=l,n.attr("href",a)}),n.find("object, embed, applet, iframe, frame, input, select, textarea").remove(),n},C=function(e,i,n){i=null!=i?i:!0;var a,s,o=t("#p"+e.id,m),l=null,u=0,d=m.scrollTop(),c=function(e,i){o.data("date",i.data("date")),e.next(".lb-comment").andSelf().last().addClass("lb-comment-last").prev().removeClass("lb-comment-last"),i.data("comments",i.data("comments")+1),i.data("comments")>0&&(a=i.find(".lb-post-comments-label"),a.length||i.append(a=t("<span />",{"class":"lb-post-comments-label",text:"Comments"})))};o.length||(o=x(e),o.length&&(w&&o.addClass("lb-hidden"),e.p?(l=t("#p"+e.p,m),l.length?"comment"===e.type?(l.data("comments")>0?(s=l.nextUntil(":not(.lb-comment)",".lb-comment"),s.each(function(i,n){var a=t(n),l=Number(a.attr("id").substr(1));return e.id>l?(o.insertBefore(a),!1):i===s.length-1?(o.insertAfter(a),!1):void 0})):o.insertAfter(l),c(o,l)):o.insertBefore(l):r.push(e)):n&&n.length?o.insertAfter(n):i===!1?o.appendTo(m):o.prependTo(m),u=o.outerHeight(),u&&d&&m.scrollTop(d+u),w&&o.removeClass("lb-hidden")))},T=function(e){var i=t("#p"+e.id,m),n=0,a=0,s=0,o=m.scrollTop();i.length?(n=i.outerHeight(),i=x(e,i),i&&(a=i.outerHeight(),s=a-n,s&&o&&m.scrollTop(o+s),i.hide().fadeIn(400))):U(e.id,e)},D=function(e){var i=t("#p"+e.id,m),n=0,a=m.scrollTop(),s=null;i.length?(n=i.outerHeight(),i.fadeOut(400,"swing",function(){i.hasClass("lb-comment-last")&&i.prev(".lb-comment").addClass("lb-comment-last"),i.hasClass("lb-comment")&&(s=i.prevAll(".lb-post:not(.lb-comment):first"),s.data("comments",s.data("comments")-1),0===s.data("comments")&&s.find(".lb-post-comments-label").remove()),i.remove(),n&&a&&m.scrollTop(a-n)})):U(e.id,null)},k=function(e,i){e=e||[];var n=e.length,a=this,s=10,o=(Math.ceil(n/s),0),c=w,h=function(t,e){if(C(e,c),"comment"!==e.type&&e.date){var i=e.date.getTime();u=Math.min(u,i),d=Math.max(d,i)}},p=function(){t(e.splice(0,s)).each(t.proxy(h,a)),0!==o||w||X(),e.length?setTimeout(p,0):i&&i(),o++};l>0&&n>l&&!r.length&&!m.children(".lb-post").length&&(r=e.splice(0,n-l),m.append(t("<a />",{"class":"lb-more-button lb-button",text:"Show earlier posts"})).click(t.proxy(A,this))),w||e.reverse(),setTimeout(p,0)},I=function(){var e=r.length;e&&t(r).each(function(t,e){C(e)})},A=function(e){var i=t(e.target),n=r.length,a=null,s=0,o=null;n&&(a=m.children(".lb-post:last"),s=Math.max(n-l,0),o=r.splice(s,l),t(o).each(function(t,e){C(e,a)})),r.length||i.remove()},S=function(e){var i=t("#p"+e,m);return o=!0,i.length&&m.stop().animate({scrollTop:i.get(0).offsetTop},{duration:"fast",complete:function(){o=!1}}),i},P=function(e){var i=null;return m.children(".lb-post:not(.lb-comment)").each(function(n,a){var s=t(a);return s.data("date")===e||e>s.data("date")&&s.prev().data("date")>e?(i=s,!1):void 0}),i},M=function(t){t=new Date(t);var e="am",i=t.getHours(),n=t.getMinutes(),a="",s="",o="",l=new Date,r=new Date(l.getFullYear(),l.getMonth(),l.getDate());return i>=12&&(e="pm"),0===i?i=12:i>12&&(i-=12),10>n&&(n="0"+n),a=i+":"+n+e,s=t.getMonth()+1+"/"+t.getDate()+"/"+t.getFullYear(),o=t.getTime()>=r.getTime()?a:s+", "+a},E=function(e,i){var a=window.location.href.replace(/\#.*$/,""),s=t("<a />",{"data-count":"none","data-text":'"'+n(i)+'"',"data-url":a+"#p"+e,href:"https://twitter.com/share","class":"twitter-share-button"}),o=document.createElement("DIV");return o.innerHtml=i,s},O=function(e){var i,n,a=!0;return e&&s.thumbnailExcludeFilter&&(i=(s.thumbnailExcludeFilter+"").split(/\s*,\s*/i),t.each(i,function(t,i){return i&&(n=RegExp(i,"i"),n.test(e))?(a=!1,!1):void 0})),a},U=function(t,e){if(r.length)for(var i=0;r.length>i;i++)if(r[i].id===t){e?r[i]=e:(r[i]=null,r.splice(i,1));break}},F=function(e){var n=t(e.target);i?(z(),n.text("Pause").attr("title","Stop receiving updates"),f.removeClass("lb-status-paused")):(H(),n.text("Resume").attr("title","Resume receiving updates"),f.addClass("lb-status-paused")),j()},L=function(e){t(".lb-pause-button",a).hide(),j(e)},N=function(){t(".lb-pause-button",a).show(),j()},z=function(){a.liveUpdateApi("play"),i=!1},H=function(){a.liveUpdateApi("pause"),i=!0},j=function(t){b&&(b.removeClass("lb-status-live"),t===!1?b.text("").hide():(i?b.text("Paused"):b.text("Live!").addClass("lb-status-live"),b.show()))},W=function(){g&&(g.slider("option",{min:u,max:d,disabled:!1}),q(null))},B=function(e){if(g){e=e||g.slider("value");var i=new Date(e),n=M(i);t(".lb-timeline-label",f).text(n)}},R=function(t){g&&(g.slider("value",t),B())},V=function(e){var i=t(e||window),n=null;return i.children(".lb-post").each(function(e,i){var a=t(i),s=a.height(),o=a.position().top,l=o+s;return 0>=o&&l>0?(n=a,!1):void 0}),n},Q=function(e,i,n){e=t(e),i=null!=i?i:!1,n=null!=n?n:0;var a=m.height(),s=e.height(),o=e.position().top,l=o+s;return i===!0&&(n=s),l>n&&a-n>o},q=function(){var t=V(m);t&&(t.hasClass("lb-top")||(m.children(".lb-top").removeClass("lb-top"),t.addClass("lb-top")),o||R(t.data("date"))),0===m.scrollTop()&&Y(0)},G=function(t,e){B(e.value);var i=P(e.value);i&&S(i.attr("id").substr(1))},Y=function(t){v=t,e.html("<b>"+t+"</b> new update"+(1!==t?"s":"")).toggle(t>0),t>0?c.slideDown(300):Boolean(s.tagFilter)||c.slideUp(300)},Z=function(){s.tagFilter="",window.location.hash="_",a.liveUpdateApi("reset"),a.unbind("end update"),a.trigger("begin")},$=function(e){e=t(e||m),e.find("img[data-src]").each(function(e,i){var n=t(i);n.attr("src",n.attr("data-src")).removeAttr("data-src").removeClass("lb-pending")})},X=function(){var e=!1;m.children(".lb-post").each(function(i,n){var a=t(n);if(!a.data("imagesLoaded"))if(Q(a,!1,-500))$(a),a.data("imagesLoaded",!0),e=!0;else if(e)return!1})},K=function(e){var n=window.location.hash,a=0;if(e.updates){if(s.postLimit){var o=m.find(".lb-post");if(o.length>s.postLimit){var c=o.length-s.postLimit;o.slice(-c).remove()}}W(),w?(m.scrollTop()>0?a=e.updates.length:s.tagFilter&&t.each(e.updates,function(e,i){(!i.tags||i.tags&&-1===t.inArray(s.tagFilter,i.tags))&&(a+=1)}),a>0&&Y(v+a)):r.length&&0===l&&I()}if(e.changes&&t(e.changes).each(function(t,e){T(e)}),e.deletes&&t(e.deletes).each(function(e,i){var n,a,s=t("#p"+i.id);s.length&&!s.hasClass("lb-comment")&&(n=s.data("date"),n===u&&(a=s.prev(":not(.lb-comment)"),a.length&&(u=a.data("date"))),n===d&&(a=s.next(":not(.lb-comment)"),a.length&&(d=a.data("date"))),W()),D(i)}),n.length){var h,p,f,g=n.indexOf("p");1===g&&(p=g+1,h=n.substring(p,n.length),f=S(h),f.length&&t(window).scrollTop(m.offset().top))}setTimeout(function(){X()},0),w=!0,i&&y&&(y=!1,z(),N())};a.addClass("lb"),s.toolbarEnabled&&(a.append(f=t("<div />",{"class":"lb-toolbar"}).append(t("<a />",{"class":"lb-pause-button lb-button",text:"Pause",title:"Stop receiving updates"}).bind("click",t.proxy(F,this)))),s.timelineEnabled&&t("<div />",{"class":"lb-timeline"}).append(t("<p />",{"class":"lb-timeline-label",text:"Waiting for updates..."}),g=t("<div />",{"class":"lb-timeline-slider"})).appendTo(f),b=t("<span />",{"class":"lb-status"}).hide().appendTo(f),g&&g.slider({slide:G,disabled:!0})),c=t("<div />",{"class":"lb-alert"}).appendTo(a).append(e=t("<a />",{"class":"lb-unread-count",title:"Jump to newest update"}).hide().click(function(t){t.preventDefault(),s.tagFilter?Z():m.stop().animate({scrollTop:0},{duration:"fast"})})).hide(),s.tagFilter&&(c.show().append(h=t("<span />",{"class":"lb-tag-filter",html:"Showing all updates with the <b>"+s.tagFilter+"</b> tag. "})),p=t("<a />",{href:"#",text:"View all updates"}).appendTo(h).bind("click",function(t){t.preventDefault(),Z()})),m=t("<div />",{"class":"lb-post-container"}).appendTo(a).scroll(t.throttle(250,q)).scroll(t.debounce(100,X)),s.height&&s.height>0&&m.height(s.height),a.bind("update",function(t,e){w||i||(y=!0,H(),L()),e.updates?(s.postLimit&&s.postLimit<e.updates.length&&e.updates.splice(0,e.updates.length-s.postLimit),0===u&&(u=(new Date).getTime()),k(e.updates,function(){K(e)})):K(e)}),a.bind("end",function(){L(!1)}),s.alive===!1||s.end&&s.end<=new Date?L(!1):(i=!1,j())}),a.delegate(".tag","click",function(e){s.tagFilter=t(e.currentTarget).text(),a.liveUpdateApi("reset"),a.unbind("end update"),a.trigger("begin")}),a.delegate("img:not(.lb-profile-image)","click",function(e){var i=t(e.currentTarget),n=i.attr("data-full-src"),a=n?n:i.attr("src"),s=t("<div />",{"class":"lb-img-loading"}),o=t("<span />",{html:"Loading&hellip;"}),l=t("<img />",{src:a}),r=t("<div />").prependTo("body");s.insertBefore(i),i.detach().appendTo(s),o.appendTo(s).hide().fadeIn("fast"),l.imagesLoaded(function(){var e=t(window),n=100,a=e.width()-n,o=e.height()-n;i.detach().insertAfter(s),s.remove(),r.append(l),l.width()>a&&(l.width(a),l.height()>o&&(l.height(o),l.width(""))),l.height()>o&&(l.height(o),l.width()>a&&(l.width(a),l.height(""))),r.dialog({height:"auto",modal:!0,width:"auto",dialogClass:"lb-image-dialog",zIndex:9e3}),t(".ui-widget-overlay").bind("click",function(){r.dialog("destroy")})})}),t.browser.msie&&6>=parseInt(t.browser.version,10)&&a.delegate(".lb-button","hover",function(){t(this).toggleClass("lb-hover")}),s.tweetButtons&&("undefined"==typeof twttr&&function(t,e,i){var n,a=t.getElementsByTagName(e)[0];t.getElementById(i)||(n=t.createElement(e),n.id=i,n.src="http://platform.twitter.com/widgets.js",a.parentNode.insertBefore(n,a))}(document,"script","twitter-wjs"),a.delegate(".lb-post","mouseenter",function(e){t(e.currentTarget).find(".twitter-share-button").fadeIn("fast")}),a.delegate(".lb-post","mouseleave",function(e){t(e.currentTarget).find(".twitter-share-button").fadeOut("fast")})),a.liveUpdateApi(s)}};return this.each(function(){e=e||{},s(e)})}})(jQuery);